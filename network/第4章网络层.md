### 问题 4-1. 存在多种异构网络对不同网络之间的通信会造成一些麻烦，但为什么世界上还存在多种异构网络?
解答:世界 上之所以存在着多种异构网络，就是因为仅用一种体系结构的网络根本无法 满足所有用户的所有需求 。
OSI 假定全世界所有的人都在网络层使用X.25协议，并希望使用X.75协议将全球所有的X.25网络互连起来，从而实现全球任意计算机之间的通信。然而事实证明，大家并不愿意这样做，结果OSI失败了。这里的原因就是X.25网络并不能满足所有用户的需求，大量的用户还需要使用其他类型的网络。
在计算机网络发展初期，许多厂家都生产出具有自己独特体系结构的计算机网络。这些计算机网络就像一个个孤岛一样，它们是不能互相通信的。如果某公司的雇员需要同时接入三个不同厂商的计算机网络，那么他就需要用三台终端(即观看三个不同的屏幕显示)分别连接到不同的计算机网络。这显然是很不方便的。
在客观上存在多种异构计算机网络的现实情况下，普遍服务(universal service)的概念被提出来了。一个计算机通信系统若能够提供普遍服务，就表明该系统中的任何一对计算机都能够很方便地进行通信。像全世界的电话网就是能够提供普遍服务的一个成功例子。在世界上存在大量异构计算机网络(它们的网络硬件和物理地址的编址方法都不一样)的现实情况下，要获得普遍服务，的确是相当困难的事。但IP协议成功地解决了这个难题。不管你使用的具体网络采用什么样的硬件结构，但只要你的网络使用IP协议并给连接在网络上的主机分配了合法的IP地址，那么连接到这种虚拟的IP互连网上的任何一对计算机都可以很方便地进行通信。

### 问题 4-2. "IP 网关”和 "IP 路由器”是否为同义语?
解答:当初发明 TCP/IP 的研究人员使用 IP Gateway 作为网际互连的设备。我国的网络工作者曾使用过多种译名，如网间连接器、网闸、信关、联网机等，但最后由全国自然科学名词审定委员会(这个委员会现在改名为“全国科学技术名词审定委员会")在《计算机科学技术名词》中公布的 Gateway 标准译名为“网关”。
但是，在 20 世纪 90 年代初期美国 一家厂商认为，将 PGateway 改名为 IP Router似乎更加有利于设备的销售 。后来其他厂家也跟着改变产品的名称。在《计算机科学技术名词》中 Router 的标准译名是“路由器” 。现在 ，大家就都基本上不再使用网关这一名词了。
我们可以认为 "IP 网关”和 "IP 路由器”是同义语。

### 问题 4-3. IP 的英文名字是 Internet Protocol, 其标准一名是“网际协议”。那么 "IP 协议” 是否重复使用了“协议”，即“庄_协议”变成了“网际协议协议”呢?
解答:我们知道， IP 中的 "P" 就代表“协议”。因此仅仅说 IP 就已经是很清楚的了。 但为了强调 IP 是一个协议，所以在 IP 的后面还是加上了“协议”二字。如果完全用汉字来 表示 "IP 协议”，那么当然只能用一个“协议”，即“网际协议”。
和这个问题类似的还有名词 PC (Personal Computer), 即个人计算机。但有时为了强调 PC 是一个计算机，就常常在 PC 的后面加上一个“机”，变成了 "PC 机”。这当然不是表示“个 人计算机机”，而仍然是“个人计算机”。
在英文的教科书或文献中，有时会遇到 current flow 这样的写法。我们知道， current 是“电 流”，而 flow 是“流”。显然，这里也有些重复，我们不应当把 current flow 译为“电流流” 。


### 问题 4-4. 在文献中有时会见到对等连网 (peer-to-peer networking), 这是什么意思? 
解答:这有两重意思。
首先，这表示在互联网中，任何两个计算机都可以平等地进行通信 。 互联网对通信双方计算机的大小是不关心的 。 连接在互联网上的，可能是一个很小的 PC, 而通信的对方可能是一个很大的巨型机。这和早期的网络很不一样。早期的网络是以一个很大的主机为中心 ，和这个主机通信的是外围的许多功能上相对较弱的小终端 。 但后来计算机网络发展到以网络为中心，所有连接到网络(或互联网)上的计算机都是平等的。”对等”也有“对称"的意思， 但这并不是说，通信的两个计算机的大小规模必须是相似的，而是说，各种计算机都可以平 等地连接到互联网上。
其次，对等连网有时还用来说明计算机的通信方式。计算机网络原来都是采用“客户-服务器”的通信方式 。客户是通信服务的请求方 ，而服务器是通信服务的提供方。这两方在功能上显然是不对等的。客户进程比较简单，而服务器进程就比较复杂，运行服务器程序的机器也比较昂贵。但现在新的通信方式出现了，即相互通信的主机，可以互为客户方或服务器方 ，因 此产生了对等连网这样的名词 。

### 问题 4-5. 在互联网中，能否使用一个很大的交换机 (switch)来代替全部的路由器? 
解答:不行 。
交换机和路由器的功能是很不一样的。 交换机可在一个单个的网络中和若干个计算机相连，并且可以将一个计算机发送过来的帧转发给另一个计算机。从这一点上看，交换机具有集线器的转发帧的功能。但交换机比集线器的功能强很多 。 集线器在同一时间只允许一个计算机和其他计算机进行通信，但交换机允许多个计算机同时进行通信。路由器连接两个或几个网络，路由器可在网络之间转发分组(即 IP 数据报 )。特别是，这些互连的网络可以是异构的。
因此，如果是许多相同类型的网络互连在一起，那么用一个很大的交换机 (如果能够找得到)代替原来的 一 些路由器是可以的。但**目前的互联网是非常多的异构网络互连起来的， 我们不可能找到一种交换机可以代替互联网中的全部路由器。**因此，必须使用许多的路由器来进行网络互连。

### 问题 4-6. 为什么 IP 地址又称为“虚拟地址 ?
解答:这是因为 IP 地址是靠软件来维待的而不是靠硬件地址。我们好像构成了一个很大的使用统一IP协议的互连网络，但这个IP网络是虚拟的网络系统，因为它的通信系统，从层次上来看，是建筑在网络层上的，是抽象的通信系统。虽然许多大小不同的物理网络是相互连接起来了，但这些网络都有各自不同的物理层。例如，有的是无线网络，有的是光纤网络，并且数据的传送速率也可能相差很大。这些网络的数据链路层协议也是不相同的。如果我们从网络层来看这个庞大的异构网络，那么就好像是构成了一个很大的、统一的IP网络。
这种虚拟网络的地址也是虚拟的，因此IP地址义称为“虚拟地址”。实在的地址就是各网络和各主机的物理地址。
可以打一个比方。例如，我国所有的大学都有具体的、实在的门牌号码。我们通过邮政局给各大学寄信就要使用这样的具体地址。但是，假定教育部为了更加方便地管理这些大学，可以在一张图上把所有大学都按照一定的规律编上号码，而在这些具有编号的图上大学就构成了一个虚拟的全国大学网络。当教育部发达某个文件时，就可以按照指定的号码来发送给一些相关的大学。这就相当千我们在IP网络中按IP地址进行通信，但是文件的传送还是要按照各大学的具体门牌号码(相当于物理地址)由邮递员来交付。

### 问题 4-7. 有的文献上使用“虚拟分组" (virtual packet)这一名词。虚拟分组是什么意思? 
解答:虚拟分组就是 IP 数据报 。 因为互联网是由大量异构的物理网络互连而成的。这些物理网络的帧格式是各式各样的，它们的地址也可能是互不兼容的 。 路由器无法将一种格式的帧转发到另一种网络，因为另 -- 种网络无法识别与自己格式不同的帧的地址。路由器也不可能对不同的地址格式进行转换。
为了解决这一问题， IP 协议定义了 IP 数据报的格式。所有连接在互联网中的路由器都能识别 IP 数据报的 IP 地址，因此能够对 IP 数据报进行转发(在进行转发时当然要调用 ARP 协议以便获得相应的硬件地址)。我们知道， IP 数据报是作为物理网络的帧的数据部分。各个物理网络在转发帧时，是根据帧首部中的硬件地址而不看(实际上也看不见)帧的数据部分 。
由千所有的物理网络都看不见所传送的帧里面的 IP 数据报，这样就使得 IP 数据报得到 “虚拟分组”这样的名称 。

### <4-08> IP地址方案与我国电话号码体制的主要不同点是什么? 
解答:最主要有三个不同点
首先， IP 地址是定长的，因此在互联网上的 IP 地址总数是 一 定的 。 如果 IPv4 的地址用完了，那么就要过渡到具有更大地址空间的 IPv6。对于 IPv4 来说，每一个 IP 地址是固定的32 位 二 进制数字。 
但我国的固定电话号码是不定长度的，全国电话号码的总容量并没有上限。区号如果不够，就可以增加区号。 一个区内的电话局不够了，可以增加电话局的数目。区号可以不一致。 我国规定大城市区号是两位，如北京是 10, 南京是 25, 等等。但有的省各城市的区号都是 三 位，没有两位。而各城市电话号码的位数也是不固定的。根据城市人口的增长情况，电话号码的位数可以逐渐增多 。 可以从五位增长到六位，再增长到七位或八位。
其次， IP 地址与主机所在的地理位置无关。 IP 地址中并没有规定哪几位是分配给哪个地 理位置(我们应当注意到，在 CIDR 体制中，可以按地址块分配给某地的某个机构)，但在我 国的固定电话号码体制中，前面的区号(两位或三位)表示地理位置(按行政划分的城市范 围)，在后面的号码中前三位是电话交换机的编号，也具有固定的地理位置，最后几位则是分 配给连接到这个交换机的各电话机的编号 。 因此，一个固定电话号码= (区号)+(交换机 编号)+(电话机编号) 。
最后，每一个主机的 IP 地址在全世界是唯一的，没有重复的 IP 地址。但我们在家中可 以并联多个电话机，这些电话机都具有相同的电话号码。虽然我们不能用这些电话机同时拨 打电话，但可以在接通电话后，几个人同时使用这些并联的电话机和对方进行双向通话。

 种调用过程的 。 因此，在虚拟的 IP 网络上用 IP 地址进行通信给广大的计算机用户带来很大 的方便 。
<4-08> IP地址方案与我国电话号码体制的主要不同点是什么? 解答:最主要有三个不同点
首先， IP 地址是定长的，因此在互联网上的 IP 地址总数是 一 定的 。 如果 IPv4 的地址用
完了，那么就要过渡到具有更大地址空间的 IPv6。对于 IPv4 来说，每一个 IP 地址是固定的
32 位 二 进制数字。 但我国的固定电话号码是不定长度的，全国电话号码的总容量并没有上限。区号如果不
够，就可以增加区号。 一 个区内的电话局不够了，可以增加电话局的数目。区号可以不一致。 我国规定大城市区号是两位，如北京是 10, 南京是 25, 等等。但有的省各城市的区号都是 三 位，没有两位。而各城市电话号码的位数也是不固定的。根据城市人口的增长情况，电话号 码的位数可以逐渐增多 。 可以从五位增长到六位，再增长到七位或八位。
其次， IP 地址与主机所在的地理位置无关。 IP 地址中并没有规定哪几位是分配给哪个地 理位置(我们应当注意到，在 CIDR 体制中，可以按地址块分配给某地的某个机构)，但在我 国的固定电话号码体制中，前面的区号(两位或三位)表示地理位置(按行政划分的城市范 围)，在后面的号码中前三位是电话交换机的编号，也具有固定的地理位置，最后几位则是分 配给连接到这个交换机的各电话机的编号 。 因此，一个固定电话号码= (区号)+(交换机 编号)+(电话机编号) 。
最后，每 一 个主机的 IP 地址在全世界是唯一的，没有重复的 IP 地址。但我们在家中可 以并联多个电话机，这些电话机都具有相同的电话号码。虽然我们不能用这些电话机同时拨 打电话，但可以在接通电话后，几个人同时使用这些并联的电话机和对方进行双向通话。

### 【4-09 】试回答下列问题:
(1) 子网掩码为 255.255.255.0 代表什么意思?
(2) 一 网络现在的掩码为 255.255.255.248, 问该网络能够连接多少个主机?
(3) - A 类网络和 一 B 类网络的子网号（主机号中可以借出来若干位用来划分子网，借出来的就是子网号） subnet-id 分别为 16 个 1 和 8 个 I, 问这两个网络的子网掩码有何不同?
(4) 一个 B 类地址的子网掩码是 255.255.240.0, 试问在其中每一个子网上的主机数最多是多少?
(5) - A 类网络的子网掩码为 255.255.0.255, 它是否为一个有效的子网掩码? 
(6) 某个 IP 地址的十六进制表示是 C2.2F.14.81. 试将其转换为点分十进制的形式。这个地址是哪一类 IP地址?
(7) C 类网络使用子网掩码有无实际意义?为什么?
解答: 具体分析如下:
(1) 可以是 C 类地址对应的子网掩码默认值，也可以是 A 类或 B 类地址的掩码，这时主机号由最后 8 位决定，而路由器寻找网络由前 24 位决定 。 
(2) 分析一下IP地址中最后一个字节:
 248= 128 +64+32+ 16+8, 一共用掉 8 位中的 5 位，剩下 3 位分配给主机号。扣除全 0 和全 l 的主机号，可用的共 6 个主机号。
(3) A类网络的掩码前面有 8个 l, 子网号 subnet-id用了 16个 l, 因此掩码有 24个 1 和 8 个 0。
B类网络的掩码前面有16个I, 子网号subnet-id用了8个1, 因此掩码有24个l和8 个 0。
可见这两个网络的子网掩码一样，但它们的子网数目不同 。
(4) IP 地址中的 第 3 个字节是 240= 128+64+32+ 16, 表明子网号 subnet-id 用了 4 个 1。 B类网络的掩码前面是16个1。可见这个网络的子网掩码为20个1, 剩下后面12个0。因此 每 一 个子网上的主机最多可有 212 — 2 = 4094 个(不使用全 0 和全 l 的主机号)。
(5) 是一个有效的子网掩码，但不推荐这样使用，因为子网中的 1 不是连续的。
(6) 把十 六进制的数转换为十进制的数:
C216 = 12 x 16 + 2 = 192 + 2 = 194 
2F16 = 2 x 16 + 15 = 32 + 15 = 47 
1416= 1 X 16+4= 16+4=20 
8116=8 X J6+ 1= 128+ 1= 129
因此，点分十六进制地址 C2.2F.14.81 =点分十进制地址 194.47.20.129,是C类地址。
(7) 有实际意义。对千小网络这样做还可进一步划分几个子网 。
例如，一个 C 网络可以再划分为 6 个子网(使用地址中的最后一个字节的前三位)，剩下的 5 位用来分配给主机，每个子网最多可以有 30 个主机 。这时的掩码是 27 个 1 , 后面5个0。

### <4-10> 试辨认以下 lP地址的网络类别。 
(1) 128.36.1 99.3
(2) 21.12.240.17 
(3) 183.194.76.253 
(4) 192.12.69.248 
(5) 89.3.0.1
(6) 200.3.6.2
解答: (2)和(5)是 A 类，因为第一位(类别位)是 0。 
(1)和(3)是 B 类，因为前两位(类别位)是 10。 
(4)和(6)是C类，因为前三位(类别位)是 110。

### 【4-11 】 IP 数据报中的首部检验和并不检验数据报中的数据。这样做的最大好处是什么?缺点是什么?
解答: 好处是，不检验数据部分可以加快检验的过程，使转发分组更快。
缺点是，数据部分出现差错时不能及早发现。即使是到达了终点，目的主机中的 IP 也仍然不检查数据部分是否正确 。当 IP 数据报的数据部分送交上面的运输层时，运输层的 TCP 才检查收到的数据有无差错 。

### <4-12 > 当某个路由器发现一 IP 数据报的首部检验和有差错时，为什么采取丢弃的办法 而不是要求源站重传此数据报?计算首部检验和为什么不采用 CRC 检验码?
解答: IP **首部中的源地址也可能变成错误的**，要求错误的源地址重传数据报是没有意义的。不使用 CRC 可减少路由器进行检验的时间。

### <4-13 >设 IP 数据报使用固定首部，其各字段的具体数值如图 T-4-13 所示(除 IP 地址 外，均为十进制表示)。试用二进制运算方法计算应当写入到首部检验和字段 中的数值(用二进制表示)。
解答:把以上的数据写成二进制数字，按每 16位对齐，然后计算反码运算的和:
本题只要仔细一些，就不会算错。但务请注意进位。
例如，最低位相加，一共有 4 个 1, 相加后得二进制的 100, 把最低位的 0 写下，作为和 的最低位。进位中的 0 不必管它，进位中的 1 要与右边第 3 位相加。
右边第 2 位相加时，只有一个 1, 相加后得 1, 没有进位。把 l 写在右边第 2 位上。
右边第 3 位相加时，共有 4个 1 和一个进位的 1, 即总共 5 个 1, 相加后得 101。把这个 和最右边的 1 写在和的右边第 3 位上。进位的 1 应当与右边第 5 位的数字相加，等等。

### 【4-14】重新计算上题，但使用十六进制运算方法 (每 16 位二进制数字转换为 4 个十六进制数字，再按十六进制加法规则计算)。比较这两种方法。
 解答:这两种方法得出的结果是一样的。

 ### <4-15 > 什么是最大传送单元 MTU? 它和 IP 数据报首部中的哪个字段有关系? 
解答:我们知道，在 IP 层下面的每一种数据链路层都规定了一个帧所能传送的数据的最大值。这数值称为 (Ip 层下面的数据链路层所能够传送的)最大传送单元 MTU。当 IP 数据 报封装成链路层的帧时，此数据报的总长度(即首部加上数据部分)一定不能超过下面的数据链路层的 MTU 值。
显然， MTU 就是 IP 数据报首部中的“总长度字段”的上限值。需要注意的是。这个总长度字段是 16 位，因此这个字段可以表示的最大数值是 i16- l, 即 65535 字节。但实际上， 下面的数据链路层往往限制了 IP 数据报的总长度要远远小千这个数值。
总之， IP 数据报首部中的总长度既不能超过 65535 字节，也不能超过数据链路层容许的MTU 值 。或者用公式表示为 :
IP 数据报首部中的总长度 <= min{MTU, 65535}
图 T-4-15 表明 IP 数据报的总长度就是数据链路层的 MAC 帧的数据部分。但 MTU 在这个图中并未表示出来，因为 MTU 是 MAC 帧的数据部分的上限值。

### 【4-16】在互联网中将 IP 数据报分片传送的数据报在最后的目的主机进行组装 。还可以 有另 一种做法，即数据报片通过一个网络就进行一次组装。试比较这两种方法的优劣 。
 解答: 在目的站而不是在中间的路由器进行组装是由于:
(I) 路由器处理数据报更简单些;
(2) 并非所有的数据报片都经过同样的路由器，因此在每一个中间的路由器进行组装可能总会缺少几个数据报片;
(3) 也许分组 后面还要经过一个网络，它还要给这些数据报片划分成更小的片。如果在中间的路由器进行组装就可能会组装多次。

### <4-17> 一个3200位长的TCP报文传到IP层，加上160位的首部后成为数据报。下面 的互联网 由两个局域网通过路由器连接起来 ，但第二个局域网所能传送的最长 数据帧中的数据部分只有 1200 位，因此数据报在路由器必须进行分片 。 试问 第二个局域网向其上层要传送多少比特的数据(这 里 的“数据“ 当然指的是局 域网看见的数据)?
解答:第 二个局域网所能传送的最长数据帧中的数据部分 只有 1200bit, 可见每 一 个 IP 数 据报的最大长度是 1200b仆，故其数据部分最多为:
IP 数据报的总长度- IP 数据报的 首部= 1200- 160 = 1040 bit
而TCP交给IP的数据共3200bit=1040+1040+1040+80, 因此3200bit的数据必须划 分为 4 个数据报片，如图 T-4-17 所示。
图中的 HI, H2, H3, H4 分别是这 四个数据报片的首部，其长度都是 160 bit C但里面的内 容并不相同)，而 TCP_!, TCP_2, TCP_3, TCP_4 分别是这四个数据报片的数据部分，其长度 分别为 I040 bit, I040 bit, I040 bit 和 80 bit。这四个数据报片的总长度(首部加上数据部分) 分别为 1200 bit, 1200 bit, 1200 bit 和 240 bit
上面这些就是第二个局域网向其上层要传送的数据 。 因此，第二个局域网向上传送 1200 + 1200 + 1200 + 240 = 3840 bit。

### <4-18 >请回答下列问题:
(I) 有人认为: "ARP 协议向网络层提供了转换地址的服务， 因此 ARP 应当
属千数据链路层。”这种说法为什么是错误的?
(2) 试解释为什么ARP 高速缓存每存入一个项目就要设置 10 ~ 20 分钟的超时计时器 。这个时间设置得太大或太小会出现什么问题?
(3) 至少举出两种不需婓发送 ARP 请求分组的情况(即不需要请求将某个目的 IP 地址解析为相应的硬件地址) 。
 解答:
(1) 不能说 "ARP 向网络层提供了服务”，因为 ARP 本身是网络层的一部分(但IP使用ARP)。数据链路层使用硬件地址而不使用IP地址，因此ARP不在数据链路层。
(2) 当网络中某个 IP 地址和硬件地址的映射发生变化时， ARP 高速缓存中相应的项目就要改变。例如，更换以太网网卡就会发生这样的事件。 10-20分钟更换一块网卡是合理的。 超时时间设置得太短会使 ARP 请求和响应分组的通信量太频繁，而超时时间设置得太长会使更换网卡后的主机迟迟无法和网络上的其他主机通信。
(3) 在源主机的 ARP 高速缓存中已经有了该目的 IP 地址的项目;源主机发送的是广播分组;源主机和目的主机使用点对点链路。

### <4-19 > 主机 A 发送 IP 数据报给主机 B, 途中经过了 5 个路由器。试问在 IP 数据报的 发送过程中总共使用了几次 ARP?
解答: 6 次。主机发送 IP 数据报时用一次 ARP, 每一个路由器在转发 IP 数据报时各使用一次。

### 【4-21 】某单位分配到一个 B 类 IP 地址，其 net-id 为 129.250.0.0。该单位有 4000 台机 器，平均分布在 16 个不同的地点。如选用子网掩码为 255.255.255.0, 试给每一个地点分配一个子网号码，并算出每个地点主机号码的最小值和最大值。
解答: 4000 台计算机，平均分布在 16 个不同的地点。每个地点有 250 台计算机。因此，主机号 host-id 有 8 位就够了。而 16 个不同地点需要有 16 个子网。考虑到不使用全 l 和全 0 的子网号，因此子网号 subnet-id 至少需要 5 位(可以有 30 个子网)。这样，本题的解答并不 是唯一的，子网号可以从 5 位到 8 位。
但题目已经给定了子网掩码为 255.255.255.0, 就是说，题目已经确定了采用 8 位的子网 号，因此可以选用子网号从 00000001 到 00001000 这样 16 个号码。每一个地点的主机号 host-id 从 00000001 到 11111010 共 250 个号码。

### <4-22 > 一个数据报长度为 4000 字节(固定首部长度)。现在经过一个网络传送，但此网络能够传送的最大数据长度为 1500 字节。试问应当划分为几个短些的数据报片?各数据报片的数据字段长度、片偏移字段和 MF 标志应为何数值?
解答:数据报的总长度减去首部长度，得出 IP 数据报的数据部分长度为:
4000- 20=3980B
划分出一个数据报片 (要考虑首部有 20 字节长): 3980 - 1480 = 2500 B, 剩下的数据长度，大于 MTU。
再划分出一个数据报片: 2500 —1480 = 1020 B, 剩下的数据长度，小千 MTU。 故划分为 3 个数据报片，其数据字段长度分别为 1480, 1480 和 1020 字节。 片偏移字段的值分别为 0,1480/8=185 和 2xl480/8=370。
MF 字段的值分别为 I, 1 和 0。

### 【4-23】分两种情况(使用子网掩码和使用 CIDR) 写出互联网的 IP 层查找路由的算法 。 
解答:使用子网掩码时， 互联网的 IP 层查找路由的算法如下 。
(1) 从收到的数据报的首部提取目的 IP 地址 D。
(2) 先判断是否为直接交付。对路由器直接相连的网络逐个进行检查:用各网络的子网掩码和 D 逐位相”与 "(AND 操作)，看结果是否和相应的网络地址匹配。若匹配，则把分组进行直接交付(当然还需要把 D 转换成物理地址，把数据报封装成帧发送出去)，转发任务结束。否则就是间接交付，执行 (3)。
(3) 若路由表中有目的地址为 D 的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器;否则，执行 (4)。
(4) 对路由表中的每一行(目的网络地址，子网掩码，下一跳地址)，用其中的子网掩码 和 D 逐位相”与 "(AND 操作)，其结果为 N。若 N 与该行的目的网络地址匹配，则把数据报传送给该行指明的下一跳路由器;否则，执行 (5)。
(5) 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器;否 则，执行 (6)。
(6) 报告转发分组出错 。
使用 CIDR 时（遵从CIDR规则的地址有一个后缀说明前缀的位数，例如：192.168.0.0/16。），互联网的 IP 层查找路由的算法和上面的算法并无什么不同。但应注意的 是，在使用 CIDR 时，我们使用地址掩码(这种地址掩码也常常称为子网掩码)。地址掩码的 前一部分是一连串的 1, 对应千 CIDR 中的网络前缀。而掩码中的后一部分是一连串的 0, 对 应于 CIDR 中的网络后缀(即对应千主机号部分)。在使用 CIDR 的路由表中，每个项目由“网 络前缀”和“下一跳地址”组成。但是在查找路由表时可能会得到不止一个匹配结果。这时 应当从匹配结果中选择**具有最长网络前缀的路由**。如果在路由表中的各项目是按网络前缀的长度排序的，把最长的网络前缀放在最前面，那么当查找路由表找到匹配时，就是找到了正确的路由，因而结束了查找。但如果在路由表中的各项目不是按网络前缀的长度排序，那么就应当从匹配结果中选择具有最长网络前缀的路由。

### <4-24 > 试找出可产生以下数目的 A 类子网的子网掩码(采用连续掩码): (I) 2, (2) 6, (3) 30, (4) 62, (5) 122, (6) 250。

### <4-25 >以下有 4 个 子网掩码，哪些是不推荐使用的?为什么?
(1) 176.0.0.0, (2) 96.0.0.0, (3) 127.192.0.0, (4) 255.128.0.0。
解答:
(1)176.0.0.0的第一个字节的二进制表示: 10110000, "1"不连续。不推荐使用。
(2) 96.0.0.0 的第一个字节的二进制表示: 01100000, "1" 的前面有 0。不推荐使用。
(3) 127.192.0.0 的第一个字节的 二 进制表示: 01111111, "1" 的前面有 0。不推荐使用 。 
(4) 255.128.0.0 的前面两个字节的二进制表示: 11111111 10000000。推荐使用 。 所有的 1是连续的， 1的前面没有 0。

### <4-26] 有如下的 4 个 /24 地址块，试进行最大可能的聚合。 
212.56.132.0/24
212.56.133.0/24 212.56. 134.0/24 212 .56. 135 .0/24
解答: 这几个地址的前面两个字节都一样 ，因此，只需要比较第 三个字节。 212.56.132.0/24 的第 三 个字节的二进制表示是 10000100:
212.56.133.0/24 的第三个字节的二进制表示是 10000101:
212.56.134.0/24 的第三个字节的二进制表示是 10000110:
212.56.135.0/24 的第 三个字节的二 进制表示是 10000101 。
可以看出 ，第三字节仅最后两位不都一样，而前面 6 位都是相同的(用粗体字加下划线来表示)。这 4 个地址 共同前缀是两个字节加上 6 位，即 22 位， 11010100 00111000 100001 。
最大可能的聚合的 CIDR 地址块是: 212.56.132.0/22。

### 【4-27】有两个 CIDR地址块 208.128/11 和 208.130.28/22。是否有哪一个地址块包含了 另 一 个 地址? 如果有，请 指出，并说明理由 。
解答:写出这两个地址块的二进制表示就可看出。实际上，只要把第 一 个地址块的前两个字节和第 二 个地址块的前 三 个字节写成二进制即可。
208.128/11 的网络前缀是有下划线所示的 11 位: 11010000 10000000: 208.130.28/22 的 网络前缀是有下划线所示的 22 位 : 11010000 10000010 00011100。 可见，前一个地址块包含了后一个。

 ### <4-28> 已知路由器R1的路由表如表T-4-28所示。试画出各网络和必要的路由器的连接拓扑，标注出必要的 IP 地址和接口 。 对不能确定的情况应当指明。

 ### 【4-29】 一个自治系统有 5 个局域网，其连接图如图 T-4-29 所示。 LA凡至 LANs上的 主机数分别为: 91, 150,3 和 15。该自治系统分配到的 IP地址 块 为 30.138.118/23。 试给出每一个局域网的地址块(包括前缀) 。
30.138.01110110
解答 :分配网络前缀时应先分配地址数较多的前缀。题目没有说 LAN1 上有几个主机，但至少需要 3 个地址给 3 个路由器用 。 本题的解答有很多种，
我们这个自治系统有地址块 A, 即共有 512 个 IP 地址，其网络前缀 n = 23。 32 位地址中 有 23 位是网络前缀，剩下 9 位是主机号，因此共有 29 = 512 个 IP 地址 。
把地址总数分为两大块，每 一块 的地址数 是 256 个，其网络前缀增加了 一位(请注 意: 网络前缀每增加 一 位，地址数就减半 )，即 n = 24。这就是图中的 B 和 C 两大块 。
把地址块 B 分配给 LAN3, 而把地址块 C 继续分下去 。
地址块C的一半是D, 地址数减半，是128, 网络前缀增加了一位， n=25。 LAN2得到了地址块 D。
地址块C的另一半的一半是地址块F, 地址数是64, 网络前缀n=26。 地址块F分配给 LAN5 o
在其余的 64个地址中，给 J和 K各分配 8个地址，其网络前缀 n=29。 最后剩下 48 个地址留到以后再分配。
这个分配方案也是先把总地址块分成 B 和 C 两大块，把地址块 C 分配给 LAN3
然后把地址块 B 继续分下去 。 把地址块 B 的一半 D 分配给 LAN2, 共有 128 个地址，其 网络前缀 n =25; 地址块 B 的另 一半分 成四等分 ，每一块有 32 个地址，网络前缀 n = 27。用 这四块地址中的三个(图中的E,F和G), 分配给LAN5,LAN1和LAN4


[4-30】 一个大公司有一个总部和三个下属部门。公司分配到的网络前缀是 192.77.33/24。公司的网络布局如图 T-4-30所示。总部共有五个局域网，其中的 LAN1 - LAN4都连接到路由器 R1 上，R1再通过 LANs 与路由器 R2相连 。 R2和远地的三个部门的局域网 LAN6- LAN8通过广域网相连。每一个局域网旁边标明的数字是局域网上的主机数 。试给每一个局域网分配一个合适的网络前缀。
解答: 50个主机的LAN1需要前缀/26C主机号6位， 62个主机号)， 30个主机的LAN3 需要前缀 /27 (主机号 5位， 30个主机号)，两个 10个主机的 LAN2和 LA凡各需要一个前缀 /28C主机号4位， 14个主机号)。
LAN6~ LANs (加上路由器)各需要一个前缀 /27 (主机号 5 位 ， 30 个 主机号)， 3 个 WAN 各有两个端点，各需要一个前缀 /30 C主机号 2位， 2个主机号)。 LANs需要前缀 /30 C主机 号 2 位， 2 个主机号 )，但考虑到以太网上可能还要 再接几个主机，故留有余地 ，可分配 一个 /29C主机号3位， 6个主机号)。
本题的解答有很多种，下面给出其中的 一 种 答案(先选择需要较大的网络前缀) :
LAN1: 192.77.33.0/26
LAN3: 192.77.33.64/27
LAN6: 192.77.33 .96/27
LAN7: 192.77.33.128/27
LANs: 192.77.33.160/27
LAN2: 192.77.33.192/28
LAN4: 192.77.33.208/28
LAN5: 192.77.33.224/29 (考虑到以太网上可能还要再接几个主机，故留有余地。)
WAN1: 192.77.33.232/30 
WAN2: 192.77.33 .236/30 
WAN3: 192.77.33.240/30


### <4-31 > 以下地址中的哪 一 个和 86.32/12 匹配?请说明理由。
(1) 86.33.224.123; (2) 86.79.65.216; (3) 86.58.119.74; (4) 86.68.206.154。
解答 :观察地址 86.32/12 的第二个字节 Ox32 = 00100000, 前缀 12 位，说明第二字节的前 4 位 0010 在前缀中。
把给出的四个地址的第二字节转换成二进制，看哪一个前 4 位是 0010:
(1) Ox33 = 00100001,前4位是: 0010;
(2) Ox79 = 01001111, 前4位是: 0100;
(3) Ox58 = 00111010, 前4位是: 0011;
(4) Ox68 =01000100, 前4位是: 0100;
因此只有(1)的地址 86.33.224.123 是和 86.32/12 匹配的 。

### <4-32 > 以下的地址前缀中哪 一 个地址与 2.52.90.140 匹配?请说明理由。 (1)0/4; (2)32/4; (3)4/6; (4)80/4。
解答 :给出的四个地址的前缀有 4 位和 6 位两种，因此我们就观察地址 2.52.90.140 的第 一字节 。2.52.90.140/4 是0000, 2.52.90.140/6 是 000000
(1) 0/4 是 0000;
(2) 32/4 是 0010;
(3)4/6 是000001:
(4) 80/4 是 0101 。
因此只有前缀 (1)和地址 2.52.90.140 匹配。

### 【4-33】 下面的前缀中哪 一个和地址 152.7.77.159及 152.31.47.252 都匹配?请说明理由 。 (1) 152.40/13; (2) 153.40/9; (3)152.64/12; (4) 152.0/11 。
解答 :给出的四个地址的前缀是 9 位到 12 位，因此我们就观察题目给出的两个地址的第二字节，把第二字节写成二进制 。
题目给出的两个地址的前两个字节二进制表示是:
10011000 00000111 和 10011000 00011111 。
(I)的前缀是 13 位: 10011000 001O1 , 与这两个地址不匹配。 (2)的前缀是 9 位: 10011001 0, 与这两个地址不匹配。 (3)的前缀是 12 位: 10011000 0100, 与这两个地址不匹配。 (4)的前缀是 11 位: 10011000 000, 与这两个地址都匹配。

### <4-34 > 与下列掩码相对应的网络前缀各有多少位?
(I) 192.0.0.0; (2) 240.0.0.0; (3) 255:224.0.0; (4) 255.255.255.252。
解答 :
(I) 192.0.0.0 =11000000(后面还有 24 个 0), 网络前缀:
(2) 240.0.0.0 =11110000(后面还有 24 个 0), 网络前缀:
(3) 255.224.0.0 = 11111111 11100000(后面还有 16 个 0),
(4)255.255.255.252= llllllll 111111111111111111111100, 网络前缀: 30 位。

### <4-35 > 已知地址块中的 一 个地址是 l40.120.84.24/20。试求这个地址块中的最小地址 和最大地址 。地址掩码是什么?地址块中共有多少个地址?相当千多少个 C 类 地址?
解答: 给定地址的前缀是 20 位，因此只要观察地址的第三字节即可。只把第三字节写 成 二进制，其他三个字节用 Bl,B2和 B4表示。
Bl.B2.01010IOO.B4/20 取前 20位，后面全是 O, 即得出最小地址。 最小地址是 Bl B2 01010000 00000000/20 = 140.120.80.0/20;
 最大地址是 8l B2010111 l l 11111111/20 = 140.120.95.255/20。
地址数是i2=4096, 相当于16个C类地址。
再强调 一 下: IP 地址 通常是用点分十进制或二进制来表示，不能在 IP 地址中部分使用点分十进制而另 一 部分使用 二进制表示。 像上面那样的表示方法 CBl.B2.01010100.B4) 仅仅是 强调要把注意力集中在第 三字 节上，因为网络前缀和后缀的分界线就出现在第三个字节上。

### <4-36> 已知地址块中的一个地址是 190.87.140.202/29。重新计算上题。 
解答:给定地址的前缀是 29 位，因此只要观察地址的第四字节即可。 把第四字节写成二进制，前三个字节记为Bl,B2和B3。 BlB2B311001010/29 取前29
位，后面全是 0, 即得出最小地址 。
最小地址是 Bl B2 B3 11001000/29 = 190.87.140.200/29;
最大地址是 Bl B2B311001111/29= 190.87.140.207/29。 地址数是8, 相当千1/32个C类地址。

### <4-37 > 某单位分配到一个地址块 136.23.12.64/26。现在需要进一步划分为 4 个一样大 的子网。试问:
(1) 每个子网的网 络前缀有多 长? (2) 每一个子网中有多少个地址?
(3) 每 一个子网的地 址块是什么?
(4) 每 一个子 网可分配给主机使用的最小地址和最大地址是什么?
解答:
(1) 原来网络前缀是 2 位， 需要再增加 2 位，才能划分 4 个 一 样大的子网。因此每个子网 前缀是 28 位 。
(2) 每个子网的地址中有 4 位留给主 机用，因此共有 16 个地址(可用的 14 个)。 (3) 四个子网的地址块是:
136.23.12.64/28, 136.23.12.80/28, 136.23.12.96/28, 136.23.12.112/28,
Ox64=皿 0000, Ox80=血 0000, Ox96=皿0000, Oxl12=皿 0000
(4) 地址中的前三个字节分别记为Bl,B2和B3。 第一个地址块 136.23.12.64/28可分配给主机使用的: 最小地址是 Bl B2 B3 01000001 = 136.23.12.65/28; 最大地址是 Bl B2 B301001110 = 136.23.12.78/28。 第二个地址块 136.23.12.80/28 可分配给主机使用的: 最小地址是 Bl B2 B3 01010001 = 136.23.12.81/28: 最大地址是 Bl 82 B3 01011110 = 136.23.12.94/28。 第三个地址块 136.23.12.96/28 可分配给主机使用的: 最小地址是 Bl B2 B3 01100001 = 136.23.12.97/28; 最大地址是 Bl B2 B3 01101110 = 136.23.12.110/28。 第四个地址块 136.23.12.112/28 可分配给主机使用的: 最小地址是 Bl B2 B3 01110001 = 136.23.12.113/28;
 最大地址是 BI B2 B3 01111110 = 136.23.12.126/28。

 ### <4-38 > lGP 和 EGP 这两类协议的主要区别是什么?
解答: IGP 是内部网关协议，即在一个自治系统内部使用的路由选择协议，而这与在互联网中的其他自治系统选用什么路由选择协议无关。目前这类路由选择协议使用得最多，如 RIP 和 OSPF 协议。
EGP 是外部网关协议。若源主机和目的主机处在不同的自治系统中(这两个自治系统可 能使用不同的内部网关协议)，当数据报传到一个自治系统的边界时，就需要使用一种协议将 路由选择信息传递到另一个自治系统中。这样的协议就是外部网关协议 EGP。目前使用最多 的外部网关协议是 BGP 的版本 4 (BGP-4)。

### <4-39 > 试简述 RIP, OSPF 和 BGP 路由选择协议的主要特点。
解答: RIP 是一种分布式的**基于距离向量的路由选择协议**，是互联网的标准协议，其最大优点就是简单。 RIP协议的特点是:
(1) 仅和相邻路由器交换信息。如果两个路由器之间的通信不需要经过另 一个 路由器，那么这两个路由器就是相邻的。 RIP 协议规定，不相邻的路由器不交换信息。
(2) 路由器交换的信息是当前本路由器所知道的全部信息，即自己的路由表。也就是说，交换的信息是:“我到本自治系统中所有网络的(最短)距离，以及到每个网络应经过的下一 跳路由器”。
(3) 按固定的时间间隔交换路由信息，例如，每隔 30 秒。然后路由器根据收到的路由信息更新路由表。当网络拓扑发生变化时，路由器也及时向相邻路由器通告拓扑变化后的路由信息。
OSPF 最主要的特征就是使用**分布式的链路状态协议**。 OSPF 协议的特点是:
(1) 向本自治系统中所有路由器发送信息。这里使用的方法是洪泛法，这就是路由器通过 所有输出端口向所有相邻的路由器发送信息。而每 一个 相邻路由器又再将此信息发往其所有 的相邻路由器(但不再发送给刚刚发来信息的那个路由器)。这样，最终整个区域中所有的路 由器都得到了这个信息的 一个副本。
(2) 发送的信息就是与本路由器相邻的所有路由器的链路状态，但这只是路由器所知道的部分信息。所谓“链路状态”就是说明本路由器都和哪些路由器相邻，以及该链路的"度量”。
OSPF 将这个"度量”用来表示费用、距离、时延、带宽 ，等等 。这些都由网络管理人员来决定，因此较为灵活。有时为了方便就称这个度量为“代价”。
(3) 只有当链路状态发生变化时，路由器才向所有路由器用洪泛法发送此信息。
BGP 是不同自治系统的路由器之间交换路由信息的协议，它采用**路径向量路由选择协议**。 BGP 协议的主要特点是:
(l)BGP 在自治系统之间交换“可达性“信息(即“可到达”或“不可到达")。例如，告
诉相邻路由器:”到达目的网络 N 可经过 ASx"。
(2) 自治系统之间的路由选择必须考虑有关策略。
(3) BGP 只能是力求寻找 一 条能够到达目的网络且比较好的路由(不能兜圈子)，而并非要寻找一条最佳路由。

 ### <4-40> RIP 使用 UDP, OSPF 使用 IP, 而 BGP 使用 TCP。这样做有何优点?为什么 RIP 周期性地和邻站交换路由信息而 BGP 却不这样做?
解答:
RIP 只和邻站交换信息， UDP 虽不保证可靠交付，但 UDP 开销小，可以满足 RIP 的要求。
OSPF 使用可靠的洪泛法，并直接使用 IP, 好处是灵活性好和开销更小。
BGP 需要交换整个的路由表(在开始时)和更新信息， TCP 提供可靠交付以减少带宽的 消耗。
RIP 使用不保证可靠交付的 UDP, 因此必须不断地(周期性地)和邻站交换信息才能使路由信息及时得到更新。但 BGP 使用保证可靠交付的 TCP, 因此不需要这样做。

### 【4-41 】
假定网络中的路由器 B 的路由表有如下的项目(这三列分别表示“目的网络” “距离”和“下一跳路由器") :
N1 7 A
N2 2 C
N6 8 F
N8 4 E
N9 4 F
现在 B 收到从 C 发来的路由信息(这两列分别表示“目的网络”和“距离") : N2 4
N3 8 
N6 4 
N8 3
N9 5
试求出路由器 B 更新后的路由表(详细说明每一个步骤)。 
解答: 先把收到的路由信息中的"距离“加 l:
N2 5 
N3 9
N6 5 
N8 4
N9 6
路由器 B 更新后的路由表如下:
N1 7 A 无新信息，不改变。
N2 5 C 相同的下一跳，更新。
N3 9 C 新的项目，添加进来。
N6 5 C 不同的下一跳，距离更短，更新。
N8 4 E 不同的下一跳，距离一样，不改变。
N9 4 F 不同的下 一 跳，距离更大，不改变。


<4-42 >
假定网络中路由器 A 的路由表有如下项目(格式同上题):
N1 4 B
N2 2 C 
N3 1 F 
N4 5 G
现在 A 收到从 C 发来的路由信息(格式同上题):
N1 2 
N2 1
N3 3
N4 7
试求出路由器 A 更新后的路由表(详细说明每 一 个步骤) 。
解答:先把收到的路由信息中的"距离“加 1:
N1 3
N2 2
N3 4
N4 8 
路由器 A 更新后的路由表如下:
N1 3 C 不同的下 一 跳，距离更短，改变 。
N2 2 C 相同的下 一跳，距离 一样，不变 。
N3 1 F 不同的下一跳，距离更大，不改变 。
N4 5 G 不同的下一跳，距离更大，不改变 。

IGMP 协议的要点是什么?隧道技 术在多播中是怎样使用的?
<4-43 >
解答: IGMP 是网**际组管理协议**，它不是 一个单独的协议，而是属千整个网际协议 IP 的一个组成部分。 IGMP 并非是在互联网范围内对所有多播组成员进行管理的协议。 IGMP 不知 道 IP 多播组包含的成员数，也不知道这些成员都分布在哪些网络上，等等。 IGMP 协议是 让 连接在本地局域网上的多播路由器知道本局域网上是否有主机(严格讲，是主机上的某个进 程)参加或退出了某个多播组。
显然，仅有 IGMP 协议是不能完成多播任务的。连接在局域网上的多播路由器还必须和 互联网上的其他多播路由器协同工作，以便把多播数据报用最小代价传送给所有的组成员 。 这就需要使用多播路由选择协议。
从概念上讲， IGMP 的工作可分为两个阶段。
第一阶段当某个主机加入新的多播组时，该主机应向多播组的多播地址发送 一 个 IGMP 报文，声明自己要成为该组的成员。本地的多播路由器收到 IGMP 报文后，还要利用多播路 由选择协议把这种组成员关系转发给互联网上的其他多播路由器 。
第二阶段:组成员关系是动态的。本地多播路由器要周期性地探询本地局域网上的主机， 以便知道这些主机是否还继续是组的成员。只要有 一 个主机对某个组响应，那么多播路由器 就认为这个组是活跃的。但一个组在经过几次的探询后仍然没有 一个主机响应，多播路由器 就认为本网络上的主机已经都离开了这个组，因此也就不再把这个组的成员关系转发给其他的多播路由器。
隧道技术适用于多播组的位置在地理上很分散的情况 。 例如在图 T-4-43 中，网 1 和网 2都支待多播。现在网 1 中的主机向网 2 中的 一些主机进行多播 。 但路由器民和民之间的网 络并不支持多播，因而民和 R2 不能按多播地址转发数据报 。 勾此，路由器民就对 多 播数据 报进行再次封装，即再加上普通数据报首部，使之成为向单 目的站发送的单播数据报，然 后通过"隧道”从 R1 发送到 R2
单播数据报到达路由器民后，再由路由器民剥去其首部，使它又恢复成原来的多播数 据报，继续向多个目的站转发。

### <4-44 > 什么是 VPN? VPN 有什么特点和优缺点? VPN 有几种类别?
解答: VPN 就是虚拟专用网。 VPN 的特点就是采用 TCP/IP 技术和**利用公用的互联网作为通信载体，使一个机构中分布在不同场所的主机能够像使用一个本机构的专用网那样进行通信**。之所以称为“专用网” ，是因为这种网络是为本机构的各主机用千机构内部通信的，而 不是用于和网络外非本机构的主 机通信。如果专用网不同网点之间的通信必须经过公用的互 联网，但又有保密的要求 ，那么所有通过互联网传送的数据都必须加密。“虚拟”表示“好像 是，但实际上并不是"，因为现在并没有使用真正的专用网(这需要使用专线连接)，而是通 过公用的互联网来连接分散在各场所的本地网络。 VPN 只是在效果上起到真正专用网的作用。 一 个机构要构建自己的 VPN, 就必须为其每一个场所购买专门的硬件和软件并进行配置，使每一个场所的 VPN 系统都知道其他场所的地址。
VPN 的优点是在价格上比建造专用网要便宜，但缺点是需要比较复杂的技术。当需要保密通信时，就需要有更加完善的 加密措施。经过公用的互联网通信，不管采用什么样的加密 措施，总是令人担心其安全性。
常用的 VPN 有三种:
(1) 内联网 (intranet), 或内联网 VPN: 由本机构内部网络构成的 VPN。
(2) 外联网 (extranet), 或外联网 VPN: 有某些外部机构(通常就是合作伙伴)参加而构成的 VPN。
(3) 远程接入 VPN: 能够使在外地工作的员工通过拨号接入互联网，并和本公司保待联系或开电话会议。

### <4-45 > 什么是 NAT? NAPT 有哪些特点? NAT 的优点和缺点有哪些?
解答: NAT 就是网络地址转换。 NAPT 是网络地址与端口号转换，是使用端口号的 NAT。 
NAT 的优点就是可以通过使用 NAT 路由器使专用网内部的用户和互联网连接。专用网内部的用户使用的是专用地址(也叫本地地址，如果不使用 NAT 路由器，那么这种地址是不能和互联网相连的)，但当 IP 数据报传送到 NAT 路由器后就转换成为全球 IP 地址 (NAT 路由器至少要有一个这样的全球 IP 地址) 。于是专用网的用户也就可以和互联网连接了 。 NAT 的 一个缺点是通过 NAT 路由器的通信必须由专用网内的主机发起 。设想互联网上的主机要发起 通信，当 IP 数据报到达 NAT 路由器时， NAT 路由器就不知道应凋把目的 IP 地址转换成专用 网内的哪 一个本地 IP 地址 。 NAT 的另 一 个缺点就是当 NAT 路由器只有一个全球 IP 地址时， 专用网内最多只有一个主机可以接入互联网。如果 NAT 路由器有多个全球 IP 地址，那么就 可以同时有多个主机和互联网相连 (每一个主 机占用 一 个全球 IP 地址) 。
NAPT 由千还使用了运输层的端口号，因此在 NAPT 上的 一 个全球 IP 地址，可以供专用 网中的多个主机使用(每 一个主 机使用不同的端口号) 。当 NAPT 路由器收到从互联网发来 的应答时，就可以从 IP 数据报的数据部分找出运输层的端口号，然 后 根据不同的目的端口 号，从 NAPT 转换表中找到正确的目的主机 。
从层次的角度看， NAPT 的机制有些特殊 。普通路由器在转发 IP 数据报时，对于源 IP 地址或目的 IP 地址都是不改变的。但 NAT 路由器在转发 IP 数据报时， 一 定要更换其 IP 地 址(转换源 IP 地址或目的 IP 地址) 。其次 ，普通路由器在转发分组时，是工作在网络层 。但 NAPT 路由器还要查看和转换运输层的端口号，而这本来应当属于运输层的范畴。也正因为 这样， NAPT 曾遭受了一些入的批评，认为 NAPT 的操作没有严格按照层次的关系。但不管 怎样， NAT (包括 NAPT) 已成为互联网的一个重要构件。

### <4-46 > 试把下列 IPv4 地址从二进制记法转换为点分十进制记法。 
(1) 10000001 00001011 00001011 11101111
(2) 110000011000001100011011 llllllll
(3) 11100111 11011011 1000lO11 0I101111
(4) 11111001 100110II 111110I100001111
解答:把每 8 位 一组转换成等值的十进制数，并增加分隔的点，得到: 
(1) 129.11.11.239
(2) 193.131.27.255 
(3)231.219.139.111 
(4) 249.155.251.15

### <4-47 > 下列 IPv4 地址是否有错误?如有，请指出。
(1) 111.56.045.78
(2) 221.34.7.8.20
(3) 75.45.301.14
(4) l l 100010.23.14.67
解答：
(1)在点分十进制记法中不应当有以 0 开头的数 (045)。
(2) 1Pv4 地址 不能超过 4 个字节。
(3) 每个字节必须小千或等千 255, 而 301 超过了这个范围。 
(4) 二进制记法和点分十进制记法混合使用是不允许的 。

### <4-48 > 假设一段地址的首地址为 146.102.29.0, 末地址为 146.102.32.255, 求这个地址段的地址数。
 解答:从未地址减土首地址，得出的结果是 0.0.3.255, 因此地址的数目= 3 X 256$^1$ + 255 x 256$^0$+ 1 = I024。

### <4-49 >求下列每个地址的类别。
(1) 00000001 0000101I 10000011 11011011
(2) 11000001 10011011 0000101I 11111111
(3) 10100111 10001011 1111101I 01101111
(4) 11110011 10011011 1111101I 00001111
解答:
(1) 第一位是 0。 这是 A 类地址。 
(2)前两位是I, 第三位是0。这是C类地址。 
(3)第一位是1' 第二位是0。这是B类地址。 
(4) 前四位是1。这是E类地址。

### <4-50 >求下列每个地址的类别 。 
(1) 227.12.14.87
(2) I93.14.56.22 
(3) 14.23.120.8 
(4) 252.5.15.111
解答:
(l) 第一个字节是 227 C在 224~239 之间)，是 D 类地址。 
(2) 第一个字节是 193 C在 192~223 之间)，是 C 类地址。 
(3) 第一个字节是 14 (在 0~ 127 之间)，是 A 类地址。
(4) 第一个字节是 252 (在 240~255 之间)，是 E 类地址。

### <4-51 > 给出某地址块中的 一 个地址为 73.22.17.25。 求该地址块的地址数及其首地址和 末地址。
解答:因为 73 在 0~127 之间，所以这个地址是 A 类地址 。
该地址块的地址数为 2$^{24}$=16777216。
把地址中的 24 位 主 机号都置为 O, 就得出首地址是 73.0.0.0/8。首地址被称为网络地址，它不会指派给任何主机，而是用来定义这个网络的 。
把地址中的 24 位主机号都置为 I, 就得出末地址是 73.255.255.255。这个地址也不分配给主机用。

### <4-52 > 已知某网络有 一 个地址是 I67.199.170.82/27, 问这个网络的网络掩码、网络前 缀长度和网络后缀长度是多少?
解答:网络掩码是 27 个 1 和 5 个 o. 即 255.255.255.224。这个网络前缀长度是 27, 网络 后缀长度是 5。

### <4-53 > 已知地址块中的一个地址是 167.I99.170.82/27, 求这 个地 }I!块的地址数、首地址 以及末地址各是多少?
从首地址和末地址的数值不难看出，该地址块的地址数为 32 个。

### <4-54 > 某单位分配到一个起始地址为 14.24.74.0/24 的地址块。该单位需要用到三个子 网，他们的三个子地址块的具体要求是:子网 N1 需要 120 个地址，子网 N2 需 要 60 个地址，子网 N3 需要 10 个地址。请给出地址块的分配方案。
解答:这个单位的地址块的网络前缀是 24 位，因此主机号有 8 位，即一共有 256 个地址 。 可以拿总地址的一半 028 个)分配给子网 N1 (实际上可以使用的地址数是 126 个)。这个地 址块的网络前缀是 25 位。
再将剩下地址的一半 (64 个)分配给子网 N2 (实际上可以使用的地址数是 62 个)。这个 地址块的网络前缀是 26 位。
还剩下 64 个地址，可以拿出 1/4 (即 16 个地址)分配给子网 N3 C实际上可以使用的地 址数是 14 个)。这个地址块的网络前缀是 28 位。
最后剩下 48 个地址留给以后再用。
这样，分配给子网 N1 的首地址是 14.24.74.0/25, 末地址是 14.24.74.127/25。 分配给子网凡的首地址是 14.24.74.128/26, 末地址是 14.24.74.191/26。 分配给子网 N3 的首地址是 14.24.74.192/28, 末地址是 14.24.74.207/28。

### <4-55 > 如图 T-4-55 所示，网络 145.13.0.0/16 划分为四个子网 N1, N2, N3 和 N4。这四个 子网与路由器 R 连接的接口分别是 mO, ml, m2 和 m3。路由器 R 的第五个接口 m4 连接到互联网。
(I) 试给出路由器 R 的路由表。
(2) 路由器 R 收到一个分组，其目的地址是 145.13.160.78。试解释这个分组是怎样被转发的。
解答:前四项的子网掩码都是18个连1，后面是14个连0；
只要到达的分组的目的地址不在表中给出的前四个地址中，就作为“其他“地址的分组，统统送交默认路由器(通过路由器的接口 m4)。请注意，图 T-4-55 中并没有给出路由器 R 是 怎样连接到默认路由器的，也没有给出默认路由器的 IP 地址和它的掩码 M 。因此在路由器 R 的路由表中最后一行“目的网络的子网掩码” 一栏就没有具体的掩码数值，而是写上了 M。
(2) 路由器 R 收到一个分组，其目的地址是 145.13.160.78。路由表四个子网掩码是 18 个 1, 因此只需把 D 的第三字节换算成二进制， 此结果和表 T-4-55-a 第 一 行的目的网络地址不匹配 。
同理，此结果和第 二 行的目的网络地址也不匹配 。
显然，此结果和第 三 行的目的网络地址匹配 。 因此，收到的分组从路由器的接口 m2 转发，实际上就是直接交付连接在这个网络上的目的主机 。

### <4-56> 收到一个分组，其目的地址D=11.1.2.5。要查找的路由表中有这样三项:
路由 1 到达网络 11.0.0.0/8 
路由 2 到达网络 11.l.0.0/16 
路由 3 到达网络 11.1.2.0/24
试问在转发这个分组时应当选择哪一个路由?
解答:把收到的分组的目的地址以及路由 I - 3 都表示为二进制数字，网络前缀使用粗体字加上下划线
当查找路由1时，目的网络的掩码是8个1和24个o, 即255.0.0.0。 和D进行AND操作时，得到 11.0.0.0, 结果是匹配的。
当查找路由2时，目的网络的掩码是16个1和16个o, 即255.255.0.0。和D进行AND 操作时，得到 11.1.0.0, 结果也是匹配的。
当查找路由 3 时，目的网络的掩码是 24 个 l 和 8 个 o, 即 255.255.255.0。和 D 进行 AND 操作时，得到 11.1.2.0, 结果也是匹配的。
那么应当选择哪 一个路由 呢?根据最长前缀匹配准则，应当选择路由 3, 因为路由 3 的 目的网络前缀为24, 是三个都匹配的结果中前缀最长的一个。

### <4-57> 同上题。假定路由 l 的目的网络 11.0.0.0/8 中有一个主机 H, 其 IP 地址是 11.1.2.3。当我们发送一个分组给主机 H 时，根据最长前缀匹配准则，上面的 这个路由表却把这个分组转发到路由 3 的目的网络 11.1.2.0/24。是最长前缀匹配准则有时会出错吗?
解答: 最长前缀匹配准 则是没有问题的，问题出在主机 H 的 IP 地址 。
如果单纯地看网络 11.0.0.0/8, 那么就知道这个网络的前缀是 8 位，剩下的 24 位是主机号 host-id, 因此把 host一id= 1.2.3 分配给某个主机是完全可以的。
但是我们再观察网络 11.1.0.0/16。这个网络所在的地址块是从地址块 11.0.0.0/8 分出来的。我们知道，地址块 11.0.0.0/8 可以分出来 256 个 C/16) 这样大的地址块。既然已经分出来一 个地址块 I1.1 .0.0/16, 那么网络 11.0.0.0/8 在分配本网络的主机号时，就不允许重复使用地址 块 11.1.0.0/16 中的任 何 一 个主机号。因此，网络 11.0.0.0/8 给它的一个主机分配像上面给出的 地址 11.1.2.3 是不允许的 。 这样做就会 和网 络 11.1.0.0/16 中的 host-id= 2.3 的 IP 地址重复，因而引起地址上的混乱 。
 同样道理，网络 I1. l.0.0/16 又分出来 地址块 11.1.2.0/24。因此，网络 11.1.0.0/16 在给自己 的主机分配号码时，就不能再使其 host-id 中前面的一个字节等于 2 (即 00000010), 否则就 有可能会和地址块 11.1.2.0/24 中的某个主机号重复 。

### <4-58> 已知-CIDR 地址块为 200.56.168.0/21。
(1) 试用二进制表示这个地址块。
(2) 这个 CIDR 地址块包括有多少个 C 类地址块? 
解答:
(]) 200.56.168.0/21 = 11001000 00111000 10101000 00000000 (有下划线的粗体数字表示网络号) 。
(2) C 类地址块的网络号是 24 位，比上面的 CIDR 地址块多 3 位。因此这个 CIDR 地址块 包含 2$^3$ = 8 个 C 类地址块 。

### <4-59 > 建议的 IPv6 协议没有首部检验和。这样做的优缺点是什么? 
解答:这样做的优点是对首部的处理更简单。数据链路层已经将有差错的帧丢弃了，因 此网络层可省去这一步骤 。但其缺点是可能遇到数据链路层检测不出来的差错(此概率极小)。

### <4-60 > 在 IPv4 首部中有 一 个“协议”字段，但在 IPv6 的固定首部中却没有 。 这是为什么?
解答:在 IP数据报传送的路径上的所有路由器都不需要这一字段的信息。只有目的主机 才需要协议字段 。在 IPv6 使用“下一个首部”字段完成 IPv4 中的"协议”字段的功能。

### <4-61 > 当使用 IPv6 时， ARP 协议是否需要改变?如果需要改变，那么应当进行概念 性的改变还是技术性的改变?
解答:如图 4-51 所示， IPv6 已经没有 ARP 协议了。但 IPv6 中的 ICMPv6 包括了 IPv4 中ARP的功能。 也就是说，从概念上讲， ARP的功能在IPv6中仍然是不可缺少的，但在技术上却进行了很多改进。也就是说， 1Pv4 中的 ARP 协议所完成的功能，在 IPv6 中已由新的邻居发现协议 ND 来完成了 。

### <4-62 > IPv6 只允许在源点进行分片。这样做有什么好处? 
解答:分片与重装是非常耗时的操作 。 IPv6 把这 一功能从路由器中删除，并移到网络边缘的主机中，这就可以大大加快网络中 IP 数据报的转发速度。

### <4-63 > 设每隔 1 微微秒就分配出 100 万个 1Pv6 地址。试计算大约要用多少年才能将 IPv6 地址空间全部用光。可以和宇宙的年龄(大约有 100 亿年)进行比较。
解答: IPv6 的地址空间共有 2$^{128}$个地址，或 3.4 X 10$^{38}$
1 微微秒分配出 100 万个地址，相当于 1 秒钟分配 10$^{18}$个地址。 1 年=365X24X3600=3]536000秒
 1 秒钟分配 10$^{18}$ 个地址，可分配 1.078 X 10$^{13}$ 年。大约是宇宙年龄的 1000 倍。地址空间 的利用不会是均匀的。但即使只利用整个地址空间的 1/1000, 那也是不可能用完的。

### 【4-64】试把以下的 1Pv6地址用零压缩方法写成简洁形式。 
(1) OOOO:OOOO:OF53:6382:AB00:67DB:BB27:7332
(2) 0000:0000:0000:0000:0000:0000:004D:ABCD
(3) OOOO:OOOO:OOOO:AF36:7328:0000:87AA:0398
(4) 2819:00AF:0000:0000:0000:0035:0CB2:B271
解答: 
(I) OOOO:OOOO:OF53:6382:AB00:67DB:8B27:7332 中有下划线的一串 0 可以用两个 冒号表示，即::F53:6382:AB00:67DB:BB27:7332 。
(2) 0000:0000:0000:0000:0000:0000:004D:ABCD 中有下划线的一串 0 可以用两个冒号表示， 即::4D:ABCD 。
(3) OOOO:OOOO:OOOO:AF36:7328:0000:87AA:0398 中有下划线的一串 0 可以用两个冒号表示， ::AF36:7328:0:87AA:398 。
以上地址中的一个 0000 可简化为一个 0, 而 0398 可简化为 398。
(4) 2819:00AF:0000:0000:0000:0035:0CB2:B271中有下划线的一串0可以用两个冒号表示，
即 2819:AF: :35:CB2:B271 。
以上地址中的 OOAF 可简化为 AF, 而 OCB2 可简化为 CB2。

### 【4-65】试把以 下零压缩的 IPv6 地址写成原来的形式。 
(1) 0::0
(2) O:AA::O
(3) 0:1234::3
(4) 123::1:2
解答:被 恢复的零压缩用下划线的 0 表示。
(1) 0000:0000:0000:0000:0000:0000:0000:0000
(2) 0000:00AA: 0000:0000:0000:0000:0000:0000, 最前面的 0000 原来是用一个 0 表示的，而 OOAA 原来被简写为 AA。
(3) 0000: 1234: 0000:0000:0000:0000:0000:0003, 最前面的 0000 原来是用一个 0 表示的。 
(4)0123:0000:0000:0000:0000:0000:000I:0002,最前面0123原来简写为123,而最后的0002原来简写为 2。

【4-66】从 IPv4 过渡到 IPv6 的方法有哪些?
解答:由于 现在整个互联网上使用 1Pv4 的路由器数量太大，因此，”规定一个日期，从这一天起所有的路由器一律都改用1Pv6", 显然是不可行的。这样，向 IPv6 过渡只能采用逐 步演进的办法，同时，还必须使新安装的 1Pv6 系统能够向后兼容。这就是说， IPv6 系统必 须能够接收和转发 1Pv4 分组，并且能够为 IPv4 分组选择路由。
下面介绍两种向 1Pv6 过渡的策略，即使用双协议栈和燧 道技术。
 (1) 双协议栈
双协议栈 (dual stack)是指在完全过渡到 !Pv6 之前，使 一 部分主机(或路由器)装有两个 协议栈， 1Pv4 和 1Pv6。 因此双协议栈主机(或路由器 ) 既能够和 1Pv6 的系统通信，又能够 和 1Pv4 的系统通信 。 双协议栈的主机(或路由器)记为 1Pv6/1Pv4, 表明它具有两种 IP 地址: 一个1Pv6地址， 一个IPv4地址。
双协议栈主机在和 1Pv6 主机通信时采用 IPv6 地址，而和 1Pv4 主机通信时则采用 1Pv4 地址。但双协议栈主机如何知道目的主机是采用哪 一 种地址的呢?它是使用域名系统 DNS 来查询的。若 DNS 返回的是 IPv4 地址，双协议栈的源主机就使用 IPv4 地址;当 DNS 返回 的是 1Pv6 地址，源主机就使用 IPv6 地址。
(2) 隧道技术
向 IPv6 过渡的另一种方法是隧道技术 (tunneling)。这种方法的要点就是在 1Pv6 数据报要
进入 1Pv4 网络时，把 IPv6 数据报封装成为 1Pv4 数据报(整个的 IPv6 数据报变成了 1Pv4 数 据报的数据部分)。然后， 1Pv6 数据报就在 IPv4 网络的隧道中传输。当 1Pv4 数据报离开 IPv4 网络中的隧道时再把数据部分(即原来的 1Pv6 数据报)交给主机的 IPv6 协议栈。
要使双协议栈的主机知道 1Pv4 数据报里面封装的数据是一个 1Pv6 数据报，就必须把 IPv4 首部的协议字段的值设置为 41 (41 表示数据报的数据部分是 IPv6 数据报 )。

### 【4-67】 多协议标记交换 MPLS 的工作原理是怎样的?它有哪些主要的功能? 
解答:在传统的 IP 网络中，分组每到达 一 个路由器，都必须查找路由表，并按照“最长 前缀匹配"的原则找到下一跳的 IP 地址(请注意，前缀的长度是不确定的)。当网络很大时， 查找含有大量项目的路由表要花费很多 的时间 。在出现突发性的通信量时 ， 往往还会使缓存溢出，这就会引起分组丢失、传输时延增大和服务质量下降。
MPLS 的一个重要特点就是不用长度可变的 IP地址前缀来查找转发表中的匹配项目，而是**给每一个 IP 数据报打上固定长度”标记”，然后对打上标记的 IP 数据报用硬件进行转发，** 这就使得 IP 数据报转发的过程省去了每到达一个路由器都要上升到第三层用软件查找路由表的过程，因而 IP 数据报转发的速率就大大加快了。
采用硬件技术对打上标记的 IP 数据报进行转发就称为标记交换。“交换”也表示在转发 时不再上升到第三层查找转发表，而是根据标记在第二层用硬件进行转发。 MPLS 可使用多 种链路层协议，如 PPP、以太网、 ATM 以及帧中继等。
MPLS 的主要功能可以归纳如下:
(1) 属于 一种面向连接的连网技 术 。
(2) 在 MPLS 域中的各标记 交换路由器 LSR, 使用专门的标记分配协议 LDP 交换报文，
并找出和特定标记相对应的路径。当 IP 数据报进入 MPLS 域时就被打七标记，然后在 MPLS 域的核心部分标记交换路由器 LSR 利用硬件进行转发，这样就加快了 IP 数据报的转发速度。
(3) 在 MPLS 的上面可以采用多种协议，但 最常用的是 IP 协议 。
(4) 具有转 发等价类 FEC 的功能。入口结点并不是给每一个 IP 数据报指派 一个不同的标 记，而是将属千同样 FEC 的 IP 数据报都指派同样的标记，因而都按照同样方式转发。
(5) MPLS 可以把 FEC 用千负载平衡。网络管理员采用自定义的 FEC 就可以更好地管理 网络的资源。这种均衡网络负载的做法也称为流量工程 。